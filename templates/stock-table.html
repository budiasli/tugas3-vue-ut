<script type="text/x-template" id="tpl-mata-kuliah-row">
    <tr>
        <td class="text-nowrap">{{ item.kode }}</td>
        <td>{{ item.judul }}</td>
        <td class="text-nowrap">{{ item.kategori }}</td>
        <td class="text-nowrap">{{ item.upbjj }}</td>
        <td class="text-nowrap">{{ item.lokasiRak }}</td>
        <td class="text-right">Rp{{ item.harga.toLocaleString('id-ID') }}</td>
        
        <td class="text-right">{{ item.qty }} pcs</td>
        
        <td class="text-right">{{ item.safety }} pcs</td>

        <td class="text-nowrap">
            <div @mouseenter="showTooltip = true" @mouseleave="showTooltip = false" style="position: relative; display: inline-block;">
                
                <status-badge :status="item.status"></status-badge>
                
                <i class="fas fa-info-circle text-info ml-1" v-if="item.catatanHTML" style="cursor: pointer;"></i>

                <div v-if="showTooltip && item.catatanHTML" class="tooltip-custom" v-html="item.catatanHTML"></div>
            </div>
        </td>
        
        <td class="text-center text-nowrap">
            <button @click="edit" class="btn btn-sm btn-outline-primary mr-1" title="Edit Item"><i class="fas fa-edit"></i></button>
            <button @click="remove" class="btn btn-sm btn-outline-danger" title="Hapus Item"><i class="fas fa-trash"></i></button>
        </td>
    </tr>
</script>


<script type="text/x-template" id="tpl-edit-stock-modal">
    <div class="modal fade" :class="{ 'show': isVisible }" style="display: block;" tabindex="-1" role="dialog" v-if="isVisible" @click.self="closeModal">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Bahan Ajar: {{ itemToEdit.judul }}</h5>
                    <button type="button" class="close" @click="closeModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form @submit.prevent="saveItem">
                    <div class="modal-body" v-if="localItem.kode">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Kode</label>
                                <input type="text" class="form-control" v-model="localItem.kode" disabled>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Judul <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" v-model="localItem.judul" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Kategori</label>
                                <select class="form-control" v-model="localItem.kategori">
                                    <option v-for="k in localKategoriList" :value="k">{{ k }}</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>UPBJJ</label>
                                <select class="form-control" v-model="localItem.upbjj">
                                    <option v-for="u in localUpbjjList" :value="u">{{ u }}</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Lokasi Rak</label>
                                <input type="text" class="form-control" v-model="localItem.lokasiRak">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Catatan HTML</label>
                            <input type="text" class="form-control" v-model="localItem.catatanHTML">
                            <small class="form-text text-muted">Dapat berisi tag HTML (mis: &lt;strong&gt;, &lt;i&gt;)</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Harga (Rp)</label>
                                <input type="number" class="form-control" v-model.number="localItem.harga" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Kuantitas (Qty) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" v-model.number="localItem.qty" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Safety Stock</label>
                                <input type="number" class="form-control" v-model.number="localItem.safety" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="closeModal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="tpl-new-stock-modal">
    <div class="modal fade" :class="{ 'show': isVisible }" style="display: block;" tabindex="-1" role="dialog" v-if="isVisible" @click.self="closeModal">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Tambah Bahan Ajar Baru</h5>
                    <button type="button" class="close" @click="closeModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveNewItem">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Kode Bahan Ajar <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" v-model="newItem.kode" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Judul <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" v-model="newItem.judul" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Kategori</label>
                                <select class="form-control" v-model="newItem.kategori">
                                    <option v-for="k in kategoriList" :value="k">{{ k }}</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>UPBJJ</label>
                                <select class="form-control" v-model="newItem.upbjj">
                                    <option v-for="u in upbjjList" :value="u">{{ u }}</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Lokasi Rak</label>
                                <input type="text" class="form-control" v-model="newItem.lokasiRak">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Catatan HTML</label>
                            <input type="text" class="form-control" v-model="newItem.catatanHTML">
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Harga (Rp)</label>
                                <input type="number" class="form-control" v-model.number="newItem.harga" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Kuantitas (Qty) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" v-model.number="newItem.qty" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Safety Stock</label>
                                <input type="number" class="form-control" v-model.number="newItem.safety" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Tambahkan ke Stok</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</script>


<script type="text/x-template" id="tpl-stock-table">
    <div>
        <div class="row mb-3">
            <div class="col-md-3">
                <input type="text" class="form-control" v-model="filter.query" placeholder="Cari Kode/Judul/Lokasi...">
            </div>
            <div class="col-md-2">
                <select class="form-control" v-model="filter.upbjj">
                    <option :value="null">UPBJJ</option>
                    <option v-for="u in upbjjList" :value="u">{{ u }}</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-control" v-model="filter.kategori">
                    <option :value="null">Kategori</option>
                    <option v-for="k in kategoriList" :value="k">{{ k }}</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <button class="btn btn-warning btn-block" @click="resetFilters">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-success btn-block" @click="openNewModal">
                    <i class="fas fa-plus"></i> Item Baru
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered table-sm table-hover">
                <thead class="bg-primary text-white">
                    <tr>
                        <th @click="setSort('kode')" class="sortable">Kode</th>
                        <th @click="setSort('judul')" class="sortable">Judul</th>
                        <th @click="setSort('kategori')" class="sortable">Kategori</th>
                        <th @click="setSort('upbjj')" class="sortable">UPBJJ</th>
                        <th @click="setSort('lokasiRak')" class="sortable">Rak</th>
                        <th @click="setSort('harga')" class="sortable text-right">Harga</th>
                        <th @click="setSort('qty')" class="sortable text-right">Qty</th>
                        <th @click="setSort('safety')" class="sortable text-right">Safety</th>
                        <th @click="setSort('status')" class="sortable">Status</th>
                        <th class="text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <mata-kuliah-row 
                        v-for="item in stockFilteredAndSorted" 
                        :key="item.kode" 
                        :item="item"
                        @edit="handleEdit"
                        @delete="handleDelete">
                    </mata-kuliah-row>
                </tbody>
                <tfoot v-if="stockFilteredAndSorted.length === 0">
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            Tidak ada data stok yang ditemukan.
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <edit-stock-modal 
            :item-to-edit="itemToEdit" 
            :is-visible="isEditModalVisible"
            @close="closeEditModal"
            @save="handleSave"
            :kategori-list="kategoriList"
            :upbjj-list="upbjjList">
        </edit-stock-modal>

        <new-stock-modal
            :is-visible="isNewModalVisible"
            @close="closeNewModal"
            @save-new="handleSaveNew"
            :kategori-list="kategoriList"
            :upbjj-list="upbjjList">
        </new-stock-modal>
    </div>
</script>